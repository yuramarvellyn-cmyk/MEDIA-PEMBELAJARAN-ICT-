<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Adventure - Leaderboard Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: url('https://raw.githubusercontent.com/lorrainemydth-gif/MEDIA_PEMBELAJARAN/3b9f4f62282a6d3295520df7ccbd2c964d8ce135/LKPD%20SISWA%20MEDIA%20PEMBELAJARAN%20ICT%20%282%29.png') center/cover no-repeat, url('assets/lkpd-v3.png') center/cover no-repeat;
            background-color: #ffffff;
            background-attachment: fixed;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.15);
            pointer-events: none;
            z-index: -1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 3px solid #000;
            border-radius: 1rem;
            box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.2);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #000;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
            background: white;
        }

        .leaderboard-item:hover {
            border-color: #000;
            transform: translateX(5px);
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
        }

        .rank-badge {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 1rem;
            border: 2px solid #000;
        }

        .rank-1 { background: #FFD700; border-color: #B8860B; color: #000; }
        .rank-2 { background: #C0C0C0; border-color: #808080; }
        .rank-3 { background: #CD7F32; border-color: #8B4513; }
        .rank-other { background: #3B82F6; border-color: #1E40AF; }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000;
        }

        .player-stats {
            font-size: 0.875rem;
            color: #666;
        }

        .score-badge {
            background: #22C55E;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            border: 2px solid #000;
            text-align: center;
            min-width: 120px;
        }

        .stat-card {
            background: white;
            color: #000;
            padding: 1.5rem;
            border-radius: 1rem;
            border: 3px solid #000;
            text-align: center;
            box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3B82F6;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .button {
            background: #22c55e;
            color: white;
            border: 2px solid #000;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
        }

        .button.secondary {
            background: #3b82f6;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3B82F6;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .heading {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: #000;
        }

        .title-style {
            font-family: 'Poppins', sans-serif;
            font-weight: 900;
            -webkit-text-stroke: 2px black;
            text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="title-style text-4xl md:text-6xl font-black text-white mb-2">
                    ‚ö° PHYSICS ADVENTURE ‚ö°
                </h1>
                <p class="text-lg md:text-2xl font-bold text-white drop-shadow-lg">
                    Leaderboard Global üèÜ
                </p>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card">
                    <div class="stat-label">Total Pemain</div>
                    <div class="stat-value" id="total-players">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Score</div>
                    <div class="stat-value" id="top-score">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rata-rata Skor</div>
                    <div class="stat-value" id="avg-score">0</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="glass-card p-6 md:p-8 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="heading text-2xl md:text-3xl font-black">
                        üèÖ TOP 10 PEMAIN
                    </h2>
                    <button onclick="refreshLeaderboard()" class="refresh-btn flex items-center gap-2">
                        <span id="refresh-icon">üîÑ</span>
                        Segarkan
                    </button>
                </div>

                <div id="leaderboard-container" class="relative">
                    <div class="flex justify-center items-center h-48">
                        <div class="loading-spinner"></div>
                        <span class="ml-4 text-lg font-bold text-black">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Recent Games -->
            <div class="glass-card p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl font-black text-black mb-6">
                    ‚è±Ô∏è PERMAINAN TERBARU
                </h2>
                <div id="recent-games-container" class="relative">
                    <div class="flex justify-center items-center h-32">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div id="player-modal" class="modal-backdrop" onclick="closePlayerModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="modal-player-name">Player Name</div>
            <div id="modal-player-details" class="space-y-2"></div>
            <button onclick="closePlayerModal()" class="mt-4 refresh-btn w-full">Tutup</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ‚úÖ FIREBASE CONFIG - READY!
        const firebaseConfig = {
            apiKey: "AIzaSyAiNNIMdMC3KxMcG9FErYp55T6trpr0-bM",
            authDomain: "physics-adventure.firebaseapp.com",
            projectId: "physics-adventure",
            storageBucket: "physics-adventure.firebasestorage.app",
            messagingSenderId: "693100086058",
            appId: "1:693100086058:web:53176b45b77e367ae01453",
            measurementId: "G-55BVXS516Z"
        };

        let db;
        let leaderboardUnsubscribe;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("‚úÖ Firebase Connected!");
            initDashboard();
        } catch (error) {
            console.error("‚ùå Firebase Error:", error);
            document.getElementById('leaderboard-container').innerHTML = `
                <div class="no-data">
                    <p class="text-red-600 font-bold">‚ö†Ô∏è Gagal terhubung ke database</p>
                    <p class="text-sm text-gray-600">Pastikan Firebase config sudah benar</p>
                </div>
            `;
        }

        function initDashboard() {
            loadStats();
            loadLeaderboard();
            loadRecentGames();

            // Auto-refresh setiap 10 detik
            setInterval(refreshLeaderboard, 10000);
        }

        async function loadStats() {
            try {
                const q = query(collection(db, "game_results"));
                const snapshot = await getDocs(q);
                
                let totalPlayers = new Set();
                let totalScore = 0;
                let topScore = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalPlayers.add(data.playerName);
                    totalScore += data.score || 0;
                    topScore = Math.max(topScore, data.score || 0);
                });

                document.getElementById('total-players').textContent = totalPlayers.size;
                document.getElementById('top-score').textContent = topScore.toLocaleString('id-ID');
                document.getElementById('avg-score').textContent = Math.round(totalScore / (snapshot.size || 1)).toLocaleString('id-ID');
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }

        function loadLeaderboard() {
            if (leaderboardUnsubscribe) leaderboardUnsubscribe();

            const q = query(
                collection(db, "game_results"),
                orderBy("score", "desc"),
                limit(10)
            );

            leaderboardUnsubscribe = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('leaderboard-container');
                const results = [];

                snapshot.forEach(doc => {
                    results.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <p class="text-2xl">üì≠</p>
                            <p class="text-gray-600 font-bold">Belum ada hasil permainan</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = results.map((result, index) => {
                    const rank = index + 1;
                    let rankClass = 'rank-other';
                    if (rank === 1) rankClass = 'rank-1';
                    else if (rank === 2) rankClass = 'rank-2';
                    else if (rank === 3) rankClass = 'rank-3';

                    const playTime = result.finishTime 
                        ? new Date(result.finishTime.toDate()).toLocaleString('id-ID', { 
                            year: 'numeric', month: 'short', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit' 
                          })
                        : '-';

                    return `
                        <div class="leaderboard-item" style="animation-delay: ${index * 0.1}s">
                            <div class="rank-badge ${rankClass}">
                                ${rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank}
                            </div>
                            <div class="player-info">
                                <div class="player-name">${escapeHtml(result.playerName || 'Unknown')}</div>
                                <div class="player-stats">
                                    ‚úÖ Benar: <strong>${result.correctAnswers || 0}</strong> | 
                                    ‚ùå Salah: <strong>${result.wrongAnswers || 0}</strong> |
                                    ‚è±Ô∏è ${playTime}
                                </div>
                            </div>
                            <div class="score-badge">
                                ${(result.score || 0).toLocaleString('id-ID')} <br> poin
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function loadRecentGames() {
            const q = query(
                collection(db, "game_results"),
                orderBy("finishTime", "desc"),
                limit(5)
            );

            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('recent-games-container');
                const results = [];

                snapshot.forEach(doc => {
                    results.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <p>Tidak ada data permainan terbaru</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = results.map((result) => {
                    const finishTime = result.finishTime 
                        ? new Date(result.finishTime.toDate())
                        : new Date();
                    const timeAgo = getTimeAgo(finishTime);

                    return `
                        <div class="leaderboard-item">
                            <div style="flex: 1">
                                <div class="player-name">${escapeHtml(result.playerName || 'Unknown')}</div>
                                <div class="player-stats">${timeAgo}</div>
                            </div>
                            <div class="score-badge">
                                ${(result.score || 0).toLocaleString('id-ID')} poin
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        window.refreshLeaderboard = async () => {
            const icon = document.getElementById('refresh-icon');
            icon.style.transform = 'rotate(180deg)';
            
            await new Promise(resolve => setTimeout(resolve, 300));
            
            loadStats();
            loadLeaderboard();
            loadRecentGames();
            
            setTimeout(() => {
                icon.style.transform = 'rotate(0deg)';
            }, 600);
        };

        window.closePlayerModal = () => {
            document.getElementById('player-modal').classList.remove('active');
        };

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'baru saja';
            if (diffMins < 60) return `${diffMins} menit lalu`;
            if (diffHours < 24) return `${diffHours} jam lalu`;
            return `${diffDays} hari lalu`;
        }
    </script>
</body>
</html>
